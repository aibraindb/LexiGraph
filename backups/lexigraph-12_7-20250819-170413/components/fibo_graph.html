<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
html,body{height:100%;background:#fff;}
body{margin:0;font-family:system-ui,sans-serif;}
#toolbar{padding:8px;background:#f6f6f6;border-bottom:1px solid #ddd;display:flex;gap:8px;align-items:center;}
.btn{padding:6px 10px;border:1px solid #bbb;background:#fff;border-radius:6px;cursor:pointer;}
.btn:hover{background:#f0f0f0;}
#viz{width:100%;height:calc(100% - 46px);}
.node circle{stroke:#333;stroke-width:1px;fill:#ddd;}
.node text{font-size:12px;pointer-events:none;}
.link{stroke:#aaa;stroke-width:1px;}
.tooltip{position:absolute;pointer-events:none;background:#111;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;opacity:0;transition:opacity .1s;max-width:420px;}
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
<div id="toolbar">
  <button id="fit" class="btn">Fit</button>
  <button id="max" class="btn">â¤¢ Max</button>
  <div id="status" style="margin-left:auto;color:#666;font-size:12px;">Click a node to select</div>
</div>
<div id="viz"></div>
<div id="tooltip" class="tooltip"></div>
<script>
(function(){
  const data = window.graphData || {nodes:[], links:[]};
  const apiBase = window.apiBase || "";
  const el = document.getElementById("viz");
  const tip = document.getElementById("tooltip");
  let w = el.clientWidth, h = el.clientHeight;
  const svg = d3.select("#viz").append("svg").attr("width", w).attr("height", h);
  const g = svg.append("g");
  const zoom = d3.zoom().scaleExtent([0.2,3]).on("zoom",(ev)=>g.attr("transform",ev.transform));
  svg.call(zoom);
  const sim = d3.forceSimulation(data.nodes)
    .force("link", d3.forceLink(data.links).id(d=>d.id).distance(90))
    .force("charge", d3.forceManyBody().strength(-260))
    .force("center", d3.forceCenter(w/2, h/2));
  const link = g.append("g").selectAll("line").data(data.links).enter().append("line").attr("class","link");
  const node = g.append("g").selectAll("g").data(data.nodes).enter().append("g").attr("class","node")
    .call(d3.drag().on("start",(ev,d)=>{ if(!ev.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; })
                   .on("drag",(ev,d)=>{ d.fx=ev.x; d.fy=ev.y; })
                   .on("end",(ev,d)=>{ if(!ev.active) sim.alphaTarget(0); d.fx=null; d.fy=null; }));
  node.append("circle").attr("r",10);
  node.append("title").text(d=>d.label||d.id);
  node.append("text").attr("x",12).attr("y",4).text(d=>d.label||d.id);
  sim.on("tick",()=>{
    link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
    node.attr("transform", d=>`translate(${d.x},${d.y})`);
  });
  async function notify(uri){
    try{
      if(!apiBase) return;
      await fetch(apiBase + "/ui/set_selection?uri="+encodeURIComponent(uri), {method:"POST"});
      document.getElementById("status").textContent = "Selected: " + (uri.split("/").pop());
    }catch(e){}
  }
  node.on("click",(ev,d)=>notify(d.id));
  document.getElementById("max").onclick = ()=>{
    if (document.fullscreenElement) document.exitFullscreen(); else document.documentElement.requestFullscreen();
  };
  document.getElementById("fit").onclick = ()=>{ svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity); };
})();
</script>
</body>
</html>
